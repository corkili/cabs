<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <title th:utext="#{app.management.title}"></title>

    <!-- Bootstrap -->
    <link rel="stylesheet" th:href="@{../vendors/bootstrap/css/bootstrap.min.css}"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" th:href="@{../vendors/font-awesome/css/font-awesome.min.css}"/>
    <!-- iCheck -->
    <link rel="stylesheet" th:href="@{../vendors/iCheck/skins/flat/green.css}"/>

    <!-- bootstrap-progressbar -->
    <link rel="stylesheet" th:href="@{../vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css}"/>
    <!-- bootstrap-daterangepicker -->
    <link rel="stylesheet" th:href="@{../vendors/bootstrap-daterangepicker/daterangepicker.css}"/>

    <!-- dataTable -->
    <link th:href="@{../vendors/dataTables/css/dataTables.bootstrap.min.css}" rel="stylesheet"/>

    <!-- Custom Theme Style -->
    <link rel="stylesheet" th:href="@{../css/custom.min.css}"/>

</head>

<body class="nav-md">

<!-- flight modal -->
<div id="flightModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="flightModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="flightModalLabel">新建航班</h4>
            </div>
            <div class="modal-body">

                <div style="padding: 5px 20px;">
                    <form id="flightForm" method="post"  data-parsley-validate=""
                          class="form-horizontal form-label-left" role="form">
                        <input type="hidden" id="flightId" name="id" value=""/>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="airlineCompany">开设公司 <span class="required">*</span></label>
                            <div class="col-sm-10">
                                <select class="form-control" id="airlineCompany" name="airlineCompany" required="required"
                                       data-toggle="tooltip" data-placement="right" title="请选择开设公司">
                                    <!--/*@thymesVar id="companies" type="java.util.List<org.neu.cabs.orm.AirlineCompany>"*/-->
                                    <option value="">----请选择----</option>
                                    <option th:each="company : ${companies}" th:text="${company.companyName + '(' + company.companyCode + ')'}"
                                            th:value="${company.id}">
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="flightNumber">航班号 <span class="required">*</span></label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" id="flightNumber" name="flightNumber" required="required"
                                       data-toggle="tooltip" data-placement="right" title="请输入航班号" placeholder="格式：MG2871"/>
                            </div>
                            <label class="col-sm-2 control-label" for="takeoffDate">起飞日期 <span class="required">*</span></label>
                            <div class="col-sm-4">
                                <input type="date" class="form-control" id="takeoffDate" name="takeoffDate" required="required"
                                       data-toggle="tooltip" data-placement="right" title="请选择起飞日期"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="departureProvince">出发地 <span class="required">*</span></label>
                            <div class="col-sm-5">
                                <select class="form-control" id="departureProvince" name="departureProvince">
                                </select>
                            </div>
                            <div class="col-sm-5">
                                <select class="form-control" id="departureCity" name="departureCity"
                                        title="请选择出发地" data-toggle="tooltip" data-placement="right">
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="arrivalProvince">到达地 <span class="required">*</span></label>
                            <div class="col-sm-5">
                                <select class="form-control" id="arrivalProvince" name="arrivalProvince">
                                </select>
                            </div>
                            <div class="col-sm-5">
                                <select class="form-control" id="arrivalCity" name="arrivalCity"
                                        title="请选择到达地" data-toggle="tooltip" data-placement="right">
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="departureAirport">出发机场 <span class="required">*</span></label>
                            <div class="col-sm-10">
                                <select class="form-control" id="departureAirport" name="departureAirport"
                                        title="请选择出发机场" data-toggle="tooltip" data-placement="right">
                                    <!--/*@thymesVar id="airports" type="java.util.List<org.neu.cabs.orm.Airport>"*/-->
                                    <option value="">----请选择----</option>
                                    <th:block th:each="airport : ${airports}">
                                        <option th:each="terminal : ${airport.terminals}" th:value="${airport.id + '_' + terminal.terminalName}"
                                                th:text="${airport.iataCode + '-' + airport.chineseName + terminal.terminalName}">
                                        </option>
                                    </th:block>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="arrivalAirport">到达机场 <span class="required">*</span></label>
                            <div class="col-sm-10">
                                <select class="form-control" id="arrivalAirport" name="arrivalAirport"
                                        title="请选择到达机场" data-toggle="tooltip" data-placement="right">
                                    <!--/*@thymesVar id="airports" type="java.util.List<org.neu.cabs.orm.Airport>"*/-->
                                    <option value="">----请选择----</option>
                                    <th:block th:each="airport : ${airports}">
                                        <option th:each="terminal : ${airport.terminals}" th:value="${airport.id + '_' + terminal.terminalName}"
                                                th:text="${airport.iataCode + '-' + airport.chineseName + terminal.terminalName}">
                                        </option>
                                    </th:block>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="plannedTakeoffTime">起飞时间 <span class="required">*</span></label>
                            <div class="col-sm-4">
                                <input type="time" class="form-control" id="plannedTakeoffTime" name="plannedTakeoffTime" required="required"
                                       data-toggle="tooltip" data-placement="right" title="请输入计划起飞时间"/>
                            </div>
                            <label class="col-sm-2 control-label" for="voyage">飞行时长 <span class="required">*</span></label>
                            <div class="col-sm-4">
                                <input type="time" class="form-control" id="voyage" name="voyage" required="required"
                                       data-toggle="tooltip" data-placement="right" title="请输入预计飞行时长"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-offset-1 col-sm-3 control-label">头等 </label>
                            <label class="col-sm-3 control-label">商务 </label>
                            <label class="col-sm-3 control-label">经济 </label>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">座位数 <span class="required">*</span></label>
                            <div class="col-sm-3">
                                <input type="number" class="form-control" required="required"
                                       id="firstCabinSeatNumber" name="firstCabinSeatNumber" title="" />
                            </div>
                            <div class="col-sm-3">
                                <input type="number" class="form-control" required="required"
                                       id="businessCabinSeatNumber" name="businessCabinSeatNumber" title="" />
                            </div>
                            <div class="col-sm-3">
                                <input type="number" class="form-control" required="required"
                                       id="economyCabinSeatNumber" name="economyCabinSeatNumber"
                                       data-toggle="tooltip" data-placement="right" title="请输入座位数" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">价格 <span class="required">*</span></label>
                            <div class="col-sm-3">
                                <input type="number" class="form-control" required="required"
                                       id="firstCabinPrice" name="firstCabinPrice" title="" />
                            </div>
                            <div class="col-sm-3">
                                <input type="number" class="form-control" required="required"
                                       id="businessCabinPrice" name="businessCabinPrice" title="" />
                            </div>
                            <div class="col-sm-3">
                                <input type="number" class="form-control" required="required"
                                       id="economyCabinPrice" name="economyCabinPrice"
                                       data-toggle="tooltip" data-placement="right" title="请输入价格" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">折扣 <span class="required">*</span></label>
                            <div class="col-sm-3">
                                <input type="number" class="form-control" required="required" max="1" min="0"
                                       id="firstCabinDiscount" name="firstCabinDiscount" title="" />
                            </div>
                            <div class="col-sm-3">
                                <input type="number" class="form-control" required="required" max="1" min="0"
                                       id="businessCabinDiscount" name="businessCabinDiscount" title="" />
                            </div>
                            <div class="col-sm-3">
                                <input type="number" class="form-control" required="required"
                                       id="economyCabinDiscount" name="economyCabinDiscount" max="1" min="0"
                                       data-toggle="tooltip" data-placement="right" title="请输入折扣" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="flightState">航班状态 <span class="required">*</span></label>
                            <div class="col-sm-9">
                                <select class="form-control" id="flightState" name="state" required="required"
                                       data-toggle="tooltip" data-placement="right" title="请选择航班状态">
                                    <!--/*@thymesVar id="flightStates" type="org.neu.cabs.constant.FlightState[]"*/-->
                                    <option value="">----请选择----</option>
                                    <option th:each="state : ${flightStates}" th:value="${state.name()}" th:text="${state.state}">
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="airplane">执飞飞机 </label>
                            <div class="col-sm-9">
                                <select class="form-control" id="airplane" name="airplane"  required="required"
                                        data-toggle="tooltip" data-placement="right" title="请选择执飞飞机">
                                    <!--/*@thymesVar id="airplanes" type="java.util.List<org.neu.cabs.orm.Airplane>"*/-->
                                    <option value="">无</option>
                                    <option th:each="airplane : ${airplanes}" th:value="${airplane.id}"
                                            th:text="${'[' + airplane.belongToCompany.companyCode + ']' + airplane.airplaneSerialNumber + '(' + airplane.airplaneName + ')'}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default antoclose2" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary antosubmit2" id="submitFlightForm">确定</button>
            </div>
        </div>
    </div>
</div>
<!-- /flight modal-->

<!-- tip modal -->
<div id="tipModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="tipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close close-tip" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="tipModalLabel">提示信息</h4>
            </div>
            <div class="modal-body">
                <div style="padding: 5px 20px;">
                    <span id="tip"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default antoclose2 close-tip" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!-- /tip modal-->

<!-- loading modal -->
<div id="loadingModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title" id="loadingModalLabel">提示信息</h4>
            </div>
            <div class="modal-body">
                <div style="padding: 5px 20px;">
                    <span id="loading"></span>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /loading modal-->

<div class="container body">
    <div class="main_container">
        <div class="col-md-3 left_col">
            <div class="left_col scroll-view">
                <div class="navbar nav_title" style="border: 0;">
                    <a th:href="@{index}" class="site_title"><i class="fa fa-paw"></i> <span th:utext="#{app.management.title}"></span></a>
                </div>

                <div class="clearfix"></div>
                <br />

                <!-- sidebar menu -->
                <div th:replace="manage/sidebar :: sidebar"></div>
                <!-- /sidebar menu -->
            </div>
        </div>

        <!-- top navigation -->
        <div th:replace="manage/topnav :: topnav"></div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
            <div class="row">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="row x_title">
                        <div class="col-md-6">
                            <h3 th:utext="#{app.management.title}"></h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 col-sm-12 col-xs-12 bg-white">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>航班信息</h2>
                            <div class="nav navbar-right panel_toolbox">
                                <button id="editFlightBtn" class="btn btn-primary" disabled="disabled">编辑</button>
                                <button id="deleteFlightBtn" class="btn btn-danger" disabled="disabled">删除</button>
                                <button id="createFlightBtn" class="btn btn-dark">新建航班</button>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <table id="flightTable" class="table table-bordered jambo_table" style="white-space: nowrap; text-align: center;">
                                <thead>
                                <tr>
                                    <th>航班号</th>
                                    <th>起飞日期</th>
                                    <th>出发城市</th>
                                    <th>到达城市</th>
                                    <th>出发机场</th>
                                    <th>到达机场</th>
                                    <th>计划起飞</th>
                                    <th>计划到达</th>
                                    <th>头等座位</th>
                                    <th>商务座位</th>
                                    <th>经济座位</th>
                                    <th>头等价格</th>
                                    <th>商务价格</th>
                                    <th>经济价格</th>
                                    <th>航班状态</th>
                                    <th>所属公司</th>
                                    <th>执飞飞机</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!--/*@thymesVar id="flights" type="java.util.List<org.neu.cabs.orm.Flight>"*/-->
                                <tr th:each="flight : ${flights}" th:value="${flight.id}">
                                    <td th:text="${flight.flightNumber}"></td>
                                    <td th:text="${#dates.format(flight.takeoffDate, 'yyyy-MM-dd')}"></td>
                                    <td th:text="${flight.departureAddress.province.name + '-' + flight.departureAddress.city.name}"></td>
                                    <td th:text="${flight.arrivalAddress.province.name + '-' + flight.arrivalAddress.city.name}"></td>
                                    <td th:text="${flight.departureAirport.iataCode + '-' + flight.departureAirport.chineseName + flight.departureTerminal.terminalName}"></td>
                                    <td th:text="${flight.arrivalAirport.iataCode + '-' + flight.arrivalAirport.chineseName + flight.arrivalTerminal.terminalName}"></td>
                                    <td th:text="${#dates.format(flight.plannedTakeoffTime, 'yyyy-MM-dd HH:mm')}"></td>
                                    <td th:text="${#dates.format(flight.plannedArrivalTime, 'yyyy-MM-dd HH:mm')}"></td>
                                    <td th:text="${flight.firstCabinSeatNumber}"></td>
                                    <td th:text="${flight.businessCabinSeatNumber}"></td>
                                    <td th:text="${flight.economyCabinSeatNumber}"></td>
                                    <td th:text="${'￥' + flight.firstCabinPrice + '-' + flight.firstCabinDiscount * 10 + '折'}"></td>
                                    <td th:text="${'￥' + flight.businessCabinPrice + '-' + flight.businessCabinDiscount * 10 + '折'}"></td>
                                    <td th:text="${'￥' + flight.economyCabinPrice + '-' + flight.economyCabinDiscount * 10 + '折'}"></td>
                                    <td th:text="${flight.state.state}"></td>
                                    <td th:text="${flight.airlineCompany.companyName + '(' + flight.airlineCompany.companyCode + ')'}"></td>
                                    <td th:text="${flight.airplane == null} ? 无 : ${'[' + flight.airplane.belongToCompany.companyCode + ']' + flight.airplane.airplaneSerialNumber + '(' + flight.airplane.airplaneName + ')'}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <!-- /page content -->

        <!-- footer content -->
        <footer th:replace="manage/footer :: copy">
        </footer>
        <!-- /footer content -->
    </div>
</div>

<!-- jQuery -->
<script th:src="@{../vendors/jquery/jquery.min.js}"></script>
<script th:src="@{../vendors/jquery/jquery.form.js}"></script>
<!-- Bootstrap -->
<script th:src="@{../vendors/bootstrap/js/bootstrap.min.js}"></script>
<!-- FastClick -->
<script th:src="@{../vendors/fastclick/fastclick.js}"></script>
<!-- bootstrap-progressbar -->
<script th:src="@{../vendors/bootstrap-progressbar/bootstrap-progressbar.min.js}"></script>
<!-- iCheck -->
<script th:src="@{../vendors/iCheck/icheck.min.js}"></script>

<!-- bootstrap-daterangepicker -->
<script th:src="@{../vendors/moment/moment.min.js}"></script>
<script th:src="@{../vendors/bootstrap-daterangepicker/daterangepicker.js}"></script>

<!-- dataTable -->
<script th:src="@{../vendors/dataTables/js/jquery.dataTables.min.js}"></script>
<script th:src="@{../vendors/dataTables/js/dataTables.bootstrap.min.js}"></script>

<!-- Custom Theme Scripts -->
<script th:src="@{../js/custom.min.js}"></script>
<script th:src="@{../js/manage.js}"></script>

<script th:inline="javascript">

    $(function () {

        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");

        console.log(header + '=' + token);

        var addresses = {};

        var $flightTable = $("#flightTable");
        var $flightId = $("#flightId");
        var $airlineCompany = $("#airlineCompany");
        var $flightNumber = $("#flightNumber");
        var $takeoffDate = $("#takeoffDate");
        var $departureProvince = $("#departureProvince");
        var $departureCity = $("#departureCity");
        var $arrivalProvince = $("#arrivalProvince");
        var $arrivalCity = $("#arrivalCity");
        var $departureAirport = $("#departureAirport");
        var $arrivalAirport = $("#arrivalAirport");
        var $plannedTakeoffTime = $("#plannedTakeoffTime");
        var $voyage = $("#voyage");
        var $firstCabinSeatNumber = $("#firstCabinSeatNumber");
        var $businessCabinSeatNumber = $("#businessCabinSeatNumber");
        var $economyCabinSeatNumber = $("#economyCabinSeatNumber");
        var $firstCabinPrice = $("#firstCabinPrice");
        var $businessCabinPrice = $("#businessCabinPrice");
        var $economyCabinPrice = $("#economyCabinPrice");
        var $firstCabinDiscount = $("#firstCabinDiscount");
        var $businessCabinDiscount = $("#businessCabinDiscount");
        var $economyCabinDiscount = $("#economyCabinDiscount");
        var $flightState = $("#flightState");
        var $airplane = $("#airplane");
        var $flightForm = $("#flightForm");
        var $createFlightBtn = $("#createFlightBtn");
        var $editFlightBtn = $("#editFlightBtn");
        var $deleteFlightBtn = $("#deleteFlightBtn");
        var $flightModal = $("#flightModal");
        var $submitFlightForm = $("#submitFlightForm");
        var $tipModal = $("#tipModal");
        var $tip = $("#tip");
        var $loadingModal = $("#loadingModal");
        var $loading = $("#loading");
        var $flightModalLabel = $("#flightModalLabel");

        var create = true;

        var table = $flightTable.DataTable({
            scrollX: true
        });

        function checkFlightForm () {
            var airlineCompany = $airlineCompany.val();
            var flightNumber = $flightNumber.val();
            var takeoffDate = $takeoffDate.val();
            var departureProvince = $departureProvince.val();
            var departureCity = $departureCity.val();
            var arrivalProvince = $arrivalProvince.val();
            var arrivalCity = $arrivalCity.val();
            var departureAirport = $departureAirport.val();
            var arrivalAirport = $arrivalAirport.val();
            var plannedTakeoffTime = $plannedTakeoffTime.val();
            var voyage = $voyage.val();
            var firstCabinSeatNumber = $firstCabinSeatNumber.val();
            var businessCabinSeatNumber = $businessCabinSeatNumber.val();
            var economyCabinSeatNumber = $economyCabinSeatNumber.val();
            var firstCabinPrice = $firstCabinPrice.val();
            var businessCabinPrice = $businessCabinPrice.val();
            var economyCabinPrice = $economyCabinPrice.val();
            var firstCabinDiscount = $firstCabinDiscount.val();
            var businessCabinDiscount = $businessCabinDiscount.val();
            var economyCabinDiscount = $economyCabinDiscount.val();
            var state = $flightState.val();
            var airplane = $airplane.val();
            var serviceResult = true;
            // 匹配航班号的正则表达
            var flightNumReg = /^[A-Z]{2}\d{4}$/

            if (airlineCompany == "" || airlineCompany == null) {
                $airlineCompany.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (flightNumber == "" || flightNumber == null) {
                $flightNumber.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if(!flightNumReg.test(flightNumber)){
                $flightNumber.attr('title',"格式错误").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (takeoffDate == "" || takeoffDate == null) {
                $takeoffDate.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (departureProvince == "" || departureProvince == null) {
                $departureCity.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (departureCity == "" || departureCity == null) {
                $arrivalCity.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (arrivalProvince == "" || arrivalProvince == null) {
                $arrivalCity.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (arrivalCity == "" || arrivalCity == null) {
                $arrivalCity.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (departureAirport == "" || departureAirport == null) {
                $departureAirport.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (arrivalAirport == "" || arrivalAirport == null) {
                $arrivalAirport.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (plannedTakeoffTime == "" || plannedTakeoffTime == null) {
                $plannedTakeoffTime.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (voyage == "" || voyage == null) {
                $voyage.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            // 座位数
            if (firstCabinSeatNumber == "" || firstCabinSeatNumber == null) {
                $economyCabinSeatNumber.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if(!(firstCabinSeatNumber>=0)){
                $economyCabinSeatNumber.attr('title',"座位数不能为负").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (businessCabinSeatNumber == "" || businessCabinSeatNumber == null) {
                $economyCabinSeatNumber.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if(!(businessCabinSeatNumber>=0)) {
                $economyCabinSeatNumber.attr('title', "座位数不能为负").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (economyCabinSeatNumber == "" || economyCabinSeatNumber == null) {
                $economyCabinSeatNumber.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if(!(economyCabinSeatNumber>=0)){
                $economyCabinSeatNumber.attr('title',"座位数不能为负").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            // 价格
            if (firstCabinPrice == "" || firstCabinPrice == null) {
                $economyCabinPrice.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if (!(firstCabinPrice>=0)){
                $economyCabinPrice.attr('title',"价格不能为负").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (businessCabinPrice == "" || businessCabinPrice == null) {
                $economyCabinPrice.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if (!(businessCabinPrice>=0)){
                $economyCabinPrice.attr('title',"价格不能为负").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (economyCabinPrice == "" || economyCabinPrice == null) {
                $economyCabinPrice.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if (!(economyCabinPrice>=0)){
                $economyCabinPrice.attr('title',"价格不能为负").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            // 折扣
            if (firstCabinDiscount == "" || firstCabinDiscount == null) {
                $economyCabinDiscount.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if(firstCabinDiscount>1 || !(firstCabinDiscount>=0)){
                $economyCabinDiscount.attr('title',"折扣应该在0-1之间").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (businessCabinDiscount == "" || businessCabinDiscount == null) {
                $economyCabinDiscount.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if(businessCabinDiscount>1 || !(businessCabinDiscount>=0)){
                $economyCabinDiscount.attr('title',"折扣应该在0-1之间").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            if (economyCabinDiscount == "" || economyCabinDiscount == null) {
                $economyCabinDiscount.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }else if(economyCabinDiscount>1 || !(economyCabinDiscount>=0)){
                $economyCabinDiscount.attr('title',"折扣应该在0-1之间").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            // 状态
            if (state == "" || state == null) {
                $flightState.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }
            // 执飞飞机
            if (airplane == "" || airplane == null) {
                $airplane.attr('title',"不能为空").tooltip('fixTitle').tooltip('show');
                serviceResult = false;
            }

            return serviceResult;
        }

        function addRow(data) {
            table.row.add([
                data.id,
                data.takeoffDate,
                data.departureProvince + '-' + data.departureCity,
                data.arrivalProvince + '-' + data.arrivalCity,
                data.departureAirportStr + data.departureTerminal,
                data.arrivalAirportStr + data.arrivalTerminal,
                data.takeoffDate + ' ' + data.plannedTakeoffTime,
                data.plannedArrivalTime,
                data.firstCabinSeatNumber,
                data.businessCabinSeatNumber,
                data.economyCabinSeatNumber,
                '￥' + data.firstCabinPrice + '-' + data.firstCabinDiscount * 10 + '折',
                '￥' + data.businessCabinPrice + '-' + data.businessCabinDiscount * 10 + '折',
                '￥' + data.economyCabinPrice + '-' + data.economyCabinDiscount * 10 + '折',
                data.stateStr,
                data.airlineCompanyStr,
                data.airplaneStr
            ]).draw();
            $("#flightTable tbody td:eq(0):contains('"+ data.id + "')").parent().attr('value', data.id);
            $("#flightTable tbody tr[value='"+ data.id + "']").find("td:eq(0)").text(data.flightNumber);
        }

        var createFlightUrl = "flight/createFlight";
        var editFlightUrl = "flight/modifyFlight";

        $createFlightBtn.on('click', function () {
            create = true;
            $flightForm.resetForm();
            $flightModalLabel.text("新建航班");
            $flightModal.modal({
                keyboard: false,
                backdrop: false
            });
        });

        function createFlight() {
            $loading.text('正在创建航班，请稍后...');
            $loadingModal.modal('toggle');

            var data = JSON.stringify(getFormJson("flightForm"));
            console.log(data);
            console.log(createFlightUrl);

            $.ajax({
                type: 'POST',
                url: createFlightUrl,
                data: data,
                dataType: 'json',
                contentType: 'application/json; charset=UTF-8',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function (data) {
                    console.log(data);
                    $loadingModal.modal('toggle');
                    if (data.successful == true) {
                        $flightModal.modal('hide');
                        addRow(data.object);
                        $tip.text(data.msg);
                        $tipModal.modal('toggle');
                    } else {
                        $tip.text(data.msg);
                        $tipModal.modal('toggle');
                    }
                },
                error: function (data) {
                    console.log(data);
                    $loadingModal.modal('toggle');
                    $tip.text('信息有误');
                    $tipModal.modal('toggle');
                }
            });
        }

        function editFlight() {
            $loading.text('正在修改航班信息，请稍后...');
            $loadingModal.modal('toggle');

            var data = JSON.stringify(getFormJson("flightForm"));
            console.log(data);
            console.log(editFlightUrl);

            $.ajax({
                type: 'POST',
                url: editFlightUrl,
                data: data,
                dataType: 'json',
                contentType: 'application/json; charset=UTF-8',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function (data) {
                    console.log(data);
                    $loadingModal.modal('toggle');
                    if (data.successful == true) {
                        $flightModal.modal('hide');
                        $editFlightBtn.attr('disabled', 'true');
                        $deleteFlightBtn.attr('disabled', 'true');
                        table.row('.selected').remove().draw(false);
                        addRow(data.object);
                        $tip.text('航班信息修改成功');
                        $tipModal.modal('toggle');
                    } else {
                        $tip.text(data.msg);
                        $tipModal.modal('toggle');
                    }
                },
                error: function (data) {
                    $loadingModal.modal('toggle');
                    $tip.text('信息有误');
                    $tipModal.modal('toggle');
                }
            });
        }

        $submitFlightForm.on("click", function () {
            if (!checkFlightForm()) {
                return false;
            }
            if (create) {
                createFlight();
            } else {
                editFlight();
            }
        });

        $("#flightTable tbody").on( 'click', 'tr[value]', function () {
            if ( $(this).hasClass('selected') ) {
                $(this).removeClass('selected');
                $editFlightBtn.attr('disabled', 'true');
                $deleteFlightBtn.attr('disabled', 'true');
            }
            else {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
                $editFlightBtn.removeAttr('disabled');
                $deleteFlightBtn.removeAttr('disabled');
            }
        } );

        $deleteFlightBtn.on('click', function () {
            if (confirm("确认删除当前选中的航班吗？")) {
                var id = parseInt(table.$('tr.selected').attr('value'));
                $.ajax({
                    type: 'POST',
                    url: 'flight/deleteFlight',
                    data: {
                        flightId: id
                    },
                    dataType: 'json',
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (data) {
                        console.log(data);
                        if (data.successful == true) {
                            table.row('.selected').remove().draw(false);
                            $editFlightBtn.attr('disabled', 'true');
                            $deleteFlightBtn.attr('disabled', 'true');
                            $tip.text(data.msg);
                            $tipModal.modal('toggle');
                        } else {
                            $tip.text(data.msg);
                            $tipModal.modal('toggle');
                        }
                    },
                    error: function (data) {
                        $tip.text(data.message);
                        $tipModal.modal('toggle');
                    }
                });
            }
        });

        $editFlightBtn.on('click', function () {
            $flightForm.resetForm();
            create = false;
            $flightId.val(table.$('tr.selected').attr('value'));
            $flightNumber.val($flightTable.find("tr.selected td:eq(0)").text());
            $takeoffDate.val($flightTable.find("tr.selected td:eq(1)").text());
            var departureAddr = $flightTable.find("tr.selected td:eq(2)").text().split('-');
            $departureProvince.val(departureAddr[0]);
            fillCity($departureProvince, $departureCity);
            $departureCity.val(departureAddr[1]);
            var arrivalAddr = $flightTable.find("tr.selected td:eq(3)").text().split('-');
            $arrivalProvince.val(arrivalAddr[0]);
            fillCity($arrivalProvince, $arrivalCity);
            $arrivalCity.val(arrivalAddr[1]);
            $("#departureAirport option").each(function (){
                var txt = $(this).text();
                if($flightTable.find("tr.selected td:eq(4)").text() == txt){
                    $departureAirport.val($(this).attr('value'));
                }
            });
            $arrivalAirport.val($arrivalAirport
                .find("option:contains('"+ $flightTable.find("tr.selected td:eq(5)").text() + "')").attr('value'));
            var takeoffTime = $flightTable.find("tr.selected td:eq(6)").text();
            var arrivalTime = $flightTable.find("tr.selected td:eq(7)").text();
            $plannedTakeoffTime.val(takeoffTime.split(' ')[1]);
            $voyage.val(subTwoDateTime(takeoffTime + ":00", arrivalTime + ":00"));
            $firstCabinSeatNumber.val($flightTable.find("tr.selected td:eq(8)").text());
            $businessCabinSeatNumber.val($flightTable.find("tr.selected td:eq(9)").text());
            $economyCabinSeatNumber.val($flightTable.find("tr.selected td:eq(10)").text());
            var fp = $flightTable.find("tr.selected td:eq(11)").text();
            var bp = $flightTable.find("tr.selected td:eq(12)").text();
            var ep = $flightTable.find("tr.selected td:eq(13)").text();
            fp = fp.substr(1, fp.length - 2).split('-');
            bp = bp.substr(1, bp.length - 2).split('-');
            ep = ep.substr(1, ep.length - 2).split('-');
            $firstCabinPrice.val(fp[0]);
            $businessCabinPrice.val(bp[0]);
            $economyCabinPrice.val(ep[0]);
            $firstCabinDiscount.val(parseFloat(fp[1]) / 10.0);
            $businessCabinDiscount.val(parseFloat(bp[1]) / 10.0);
            $economyCabinDiscount.val(parseFloat(ep[1]) / 10);
            $flightState.val($flightState
                .find("option:contains('"+ $flightTable.find("tr.selected td:eq(14)").text() + "')").attr('value'));
            $airlineCompany.val($airlineCompany
                .find("option:contains('"+ $flightTable.find("tr.selected td:eq(15)").text() + "')").attr('value'));
            $airplane.val($airplane
                .find("option:contains('"+ $flightTable.find("tr.selected td:eq(16)").text() + "')").attr('value'));
            console.log($flightId.val());
            $flightModalLabel.text("编辑航班信息");
            $flightModal.modal({
                keyboard: false,
                backdrop: false
            });
        });

        $loadingModal.modal({
            show: false,
            keyboard: false,
            backdrop: false
        });

        function createAddressOption(value, content, text) {
            return '<option value="' + value + '" content="' + content + '">' + text + '</option>';
        }

        $.getJSON("../address.json", function (data) {
            console.log(data);
            if (data == null) {
                return;
            }
            addresses = [];
            var temp = {
                name: "直辖市/特别行政区",
                sub: [{
                    name: "请选择",
                    sub: []
                }],
                type: 1
            };
            $.each(data, function (index, content) {
                if (content.type == 0) {
                    temp.sub.push(content);
                } else {
                    addresses.push(content);
                }
            });
            temp.sub.splice(temp.sub.length - 1, 1);
            addresses.splice(1, 0, temp);
            addresses.splice(addresses.length - 1, 1);
            console.log(addresses);
            fillProvince($departureProvince, $departureCity);
            fillProvince($arrivalProvince, $arrivalCity);
        });

        $departureProvince.on('change', function () {
            fillCity($departureProvince, $departureCity);
        });

        $arrivalProvince.on('change', function () {
            fillCity($arrivalProvince, $arrivalCity);
        });

        function fillProvince($p, $c) {
            $p.empty();
            $.each(addresses, function (index, content) {
                if (index == 0) {
                    $p.append(createAddressOption("", index, content.name));
                } else {
                    $p.append(createAddressOption(content.name, index, content.name));
                }
            });
            $c.empty();
            $c.append(createAddressOption("", 0, addresses[0].sub[0].name));
        }

        function fillCity($p, $c) {
            console.log($p.val());
            var cities = addresses[parseInt($p.find('[value="' + $p.val() + '"]').attr('content'))];
            console.log($p.find('[value="' + $p.val() + '"]').attr('content'));
            console.log(parseInt($p.find('[value="' + $p.val() + '"]').attr('content')));
            console.log(cities);
            $c.empty();
            $c.val("");
            $.each(cities.sub, function (index, content) {
                if (index == 0) {
                    $c.append(createAddressOption("", index, content.name));
                } else {
                    $c.append(createAddressOption(content.name, index, content.name));
                }
            });
        }

        $flightModal.on('hidden.bs.modal', function (){
            $airlineCompany.tooltip('hide');
            $flightNumber.tooltip('hide');
            $takeoffDate.tooltip('hide');
            $departureProvince.tooltip('hide');
            $departureCity.tooltip('hide');
            $arrivalProvince.tooltip('hide');
            $arrivalCity.tooltip('hide');
            $departureAirport.tooltip('hide');
            $arrivalAirport.tooltip('hide');
            $plannedTakeoffTime.tooltip('hide');
            $voyage.tooltip('hide');
            $firstCabinSeatNumber.tooltip('hide');
            $businessCabinSeatNumber.tooltip('hide');
            $economyCabinSeatNumber.tooltip('hide');
            $firstCabinPrice.tooltip('hide');
            $businessCabinPrice.tooltip('hide');
            $economyCabinPrice.tooltip('hide');
            $firstCabinDiscount.tooltip('hide');
            $businessCabinDiscount.tooltip('hide');
            $economyCabinDiscount.tooltip('hide');
            $flightState.tooltip('hide');
            $airplane.tooltip('hide');
        });


    });

</script>

</body>
</html>
